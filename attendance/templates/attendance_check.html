{% extends 'base.html' %}
{% load static %}

{% block title %}Attendance Check - Face Recognition{% endblock %}

{% block content %}
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-camera me-2"></i>Face Recognition Attendance</h4>
                    <div class="webcam-container mt-3 mb-3">
                        <video id="video" width="400" height="300" autoplay playsinline style="display: none;"></video>
                        <canvas id="canvas" style="display: none; max-width: 100%;"></canvas>
                    </div>
                    <div class="d-flex justify-content-center gap-3">
                        <button id="startCamera" class="btn btn-success" onclick="startCamera()">
                            <i class="fas fa-video me-2"></i>Start Camera
                        </button>
                        <button id="stopCamera" class="btn btn-danger" onclick="stopCamera()" style="display: none;">
                            <i class="fas fa-video-slash me-2"></i>Stop Camera
                        </button>
                        <button id="captureBtn" class="btn btn-primary" onclick="capturePhoto()" style="display: none;">
                            <i class="fas fa-camera me-2"></i>Capture
                        </button>
                    </div>
                </div>
                
                <div id="result" class="mt-4 text-center"></div>
                
                <div class="mt-4 p-3 bg-light text-center">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Position your face in the camera frame and click "Start Camera" to begin
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
let video = document.getElementById('video');
let canvas = document.getElementById('canvas');
let context = canvas.getContext('2d');
let stream = null;

async function startCamera() {
    try {
        video.style.display = 'block';
        const constraints = { 
            video: { 
                width: { ideal: 1280 },
                height: { ideal: 720 },
                facingMode: 'user',
                frameRate: { ideal: 30 }
            } 
        };
        
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        
        // Wait for video to be ready
        await new Promise((resolve) => {
            video.onloadedmetadata = () => {
                video.play();
                resolve();
            };
        });
        
        document.getElementById('startCamera').style.display = 'none';
        document.getElementById('stopCamera').style.display = 'inline-block';
        document.getElementById('captureBtn').style.display = 'inline-block';
        
    } catch (err) {
        console.error('Error accessing camera:', err);
        showResult(`Error: ${err.message || 'Could not access camera. Please ensure camera permissions are granted and no other application is using it.'}`, 'danger');
        video.style.display = 'none';
    }
}

function stopCamera() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
        stream = null;
    }
    
    document.getElementById('startCamera').style.display = 'inline-block';
    document.getElementById('stopCamera').style.display = 'none';
    document.getElementById('captureBtn').style.display = 'none';
}

function capturePhoto() {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0);
    
    // Convert to base64
    const imageData = canvas.toDataURL('image/jpeg', 0.8);
    
    // Show loading
    showResult('<i class="fas fa-spinner fa-spin me-2"></i>Processing face recognition...', 'info');
    
    // Send to backend
    fetch('/attendance/recognize/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            image_base64: imageData
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showResult(`
                <div class="alert alert-success">
                    <h5><i class="fas fa-check-circle me-2"></i>Success!</h5>
                    <p><strong>${data.employee_name}</strong> (${data.employee_id})</p>
                    <p>Action: <strong>${data.action}</strong></p>
                    <p>Time: ${new Date(data.timestamp).toLocaleString()}</p>
                </div>
            `, '');
        } else {
            showResult(`
                <div class="alert alert-warning">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>Recognition Failed</h5>
                    <p>${data.message}</p>
                </div>
            `, '');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showResult('Error processing request. Please try again.', 'danger');
    });
}

function showResult(message, type) {
    const resultDiv = document.getElementById('result');
    if (type) {
        resultDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    } else {
        resultDiv.innerHTML = message;
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Auto-start camera when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Don't auto-start camera, let user click the button
    // This is better for privacy and gives better error handling
    
    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
        stopCamera();
    });
});

window.AttendanceWebSockets.initNotifications();
</script>
{% endblock %}
